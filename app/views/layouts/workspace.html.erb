<!DOCTYPE html>
<html lang="en">
<head>
  <%= render partial: 'common/meta_tags' %>
  <title><%= compose_title(@title) %></title>
  <%= render partial: 'accounts/language_settings' %>

  <% css = [:ui, :workspace] + (@stylesheets || []) + [{media: 'all'}] %>
  <% js  = [:core] + (@javascripts || []) %>
  <%= include_stylesheets *css %>
  <%= include_javascripts *js %>
  <!--[if lt IE 9]>
    <%= include_stylesheets :lt_ie_9, embed_assets: false %>
    <%= include_javascripts :lt_ie_9 %>
  <![endif]-->
  <% if Rails.env.development? %>
    <%= include_javascripts :dev_only %>
  <% end %>
  <%= csrf_meta_tag %> 

  <%= stylesheet_link_tag File.join(DC.workspace_asset_root, "css/platform_firewalled.css") %>
  <%= javascript_include_tag File.join(DC.workspace_asset_root, "js/platform_firewalled.js") %>
</head>
<body class="<%= @bodyclass %> <%= @current_account ? 'logged_in' : '' %>">
  <div class="dc-design-firewalled">
    <!--[if lt IE 11]>
      <div class="alert alert-banner alert-danger alert-center">
        You seem to be running an older, unsupported version of Internet Explorer. We canâ€™t guarantee all features will work properly unless you <%= link_to 'upgrade your browser', 'http://browsehappy.com/' %>.
      </div>
    <![endif]-->

    <%= render partial: 'common/new/header' %>
    <%= render partial: 'workspace/workspace_header' if @current_organization %>
    <%= render partial: 'common/new/flash_messages', flash: flash %>
  </div>

  <div id="container">
    <div id="content">
      <%= yield %>
    </div>
  </div>

  <div id="overlay"></div>
  <div class="selection" style="display:none;"></div>
  <div id="spinner" style="display:none;"></div>

  <script type="text/javascript">
    <%= render partial: 'common/globals.js' %>
    Organizations.reset(<%=raw @organizations.to_json(include_document_count: true, include_note_count: true) %>);
    <% if @current_account && @current_account.memberships.any? %>
      <%= render partial: 'accounts/current_account.js' %>
      Projects.reset(<%=raw @projects.to_json({account: @current_account, include_collaborators: true}) %>);
      dc.searchPrefixes = <%=raw DC::ALL_SEARCHES.to_json %>;
    <% end %>
    $(document).ready(function() {
      // If anonymous, we come out of this with:
      //   `window.Organizations`: collection of all orgs that have public docs
      // If logged in, we come out of this with:
      //   `window.Organizations`: name/slug pair of all orgs, plus full models 
      //     of orgs related to the current account
      //   `window.Accounts`: accounts that have memberships at the orgs above
      //   `window.Projects`: projects accessible to the current account
      dc.app.workspace = new dc.controllers.Workspace;
    });
  </script>

  <%= render partial: 'common/google' if @include_analytics %>

</body>
</html>
